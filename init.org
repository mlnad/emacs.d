#+TITLE: MoYu Emacs configuration
#+AUTHOR: Liu
#+EMAIL: liumiaogemini@gmail.com

#+STARTUP: content
#+STARTUP: hideblocks

* Preface
Org mode can be used to manage Emacs configuration file conviently by
=ob-tangle= module.

* Early init
#+begin_src emacs-lisp :tangle "early-init.el"
(setq gc-cons-threshold (* 128 1024 1024)
      load-prefer-newer noninteractive
      package-enable-at-startup nil
      auto-mode-case-fold nil
      fast-but-imprecise-scrolling t
      ffap-machine-p-known 'reject
      idle-update-delay 1.0
      inhibit-compacting-font-caches t
      read-process-output-max (* 64 1024)
      redisplay-skip-fontification-on-input t)

(when (getenv-internal "DEBUG")
  (setq init-file-debug t
        debug-on-error t))

(push '(menu-bar-lines . 0) default-frame-alist)
(push '(tool-bar-lines . 0) default-frame-alist)
(push '(vertical-scroll-bars) default-frame-alist)
(setq menu-bar-mode nil
      tool-bar-mode nil
      scroll-bar-mode nil)

(set-language-environment "UTF-8")
#+end_src

* Default variables
Default variables and constants with "moyu" prefix, some of these variables will be overwrited by user configuration in `.cache/userconfig` file.
#+begin_src emacs-lisp :tangle yes
(defvar moyu/full-name "Liu Miao")
(defvar moyu/email-address "liumiaogemini@foxmail.com")

(defconst *sys/win32*
  (eq system-type 'windows-nt))

(defconst *sys/linux*
  (eq system-type 'gnu/linux))

(defconst *sys/mac*
  (eq system-type 'darwin))

(defvar moyu/lsp-client 'eglot)

(defvar moyu/default-font (font-spec :family "Consolas"
                                     :size 14))

(defvar moyu/serif-font (font-spec :family "Noto Serif CJK SC"))

(defvar moyu/cache-directory
  (expand-file-name ".cache/" user-emacs-directory))

(defvar moyu/userconfig-file
  (expand-file-name "userconfig" moyu/cache-directory))

(defvar moyu/custom-file
  (expand-file-name "custom.el" moyu/cache-directory))

(defvar moyu/recentf-save-file
  (expand-file-name "recentf" moyu/cache-directory))

(defvar moyu/save-place-file
  (expand-file-name "places" moyu/cache-directory))

(defvar moyu/backup-directory-alist
  (expand-file-name "backup/" moyu/cache-directory))

(defvar moyu/project-list-file
  (expand-file-name "projects" moyu/cache-directory))

(defvar moyu/auto-save-list-prefix
  (expand-file-name "auto-save-list/.saves-" moyu/cache-directory))

(defvar moyu/layouts-directory
  (expand-file-name "layouts/" moyu/cache-directory))

(defvar moyu/quelpa-dir
  (expand-file-name "quelpa/" moyu/cache-directory))

(defvar moyu/notes-dir "~/org/"
  "User defined notes directory.")

(defvar moyu/org-roam-dir moyu/notes-dir
  "User defined org roam directory.")

(defvar moyu/org-roam-db-location
  (expand-file-name "org-roam.db" moyu/cache-directory))

(defvar moyu/notes-extensions '("org" "md" "markdown"))

(defvar moyu/rime-data-dir
  (expand-file-name "rime/" moyu/cache-directory))

(defvar moyu/elpa-pack-dir
  (expand-file-name "elpa" user-emacs-directory )
  "Packages install by package-initilize.")

(defvar moyu/elpa-subdirectory 'emacs-version)

(defvar default-package-mirror '(("melpa" . "https://melpa.org/packages/")
                                 ("gnu" . "https://elpa.gnu.org/packages/")))

(defvar emacs-china-package-mirror '(("gnu"   . "http://mirrors.ustc.edu.cn/elpa/gnu/")
                                     ("melpa" . "http://mirrors.ustc.edu.cn/elpa/melpa/")
                                     ("nongnu"   . "http://mirrors.ustc.edu.cn/elpa/nongnu/")))

(defvar emacs-tuna-package-mirror '(("gnu"   . "http://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/")
                                    ("melpa" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/")
                                    ("nongnu"   . "http://mirrors.tuna.tsinghua.edu.cn/elpa/nongnu/")))

(defvar moyu/package-mirror default-package-mirror)

(defvar moyu/org-journal-type 'daily)

(defvar moyu/theme 'doom-one)

(defvar moyu/profile-eln-caches-dir (expand-file-name "eln-caches" moyu/cache-directory))

(defvar moyu/env-file
  (expand-file-name "env" moyu/cache-directory))

(defvar moyu/transient-history-file
  (expand-file-name "transient/history.el" moyu/cache-directory))

(defvar moyu/popper-buffers
  (list "\\*Messages\\*" "Output\\*$" "^\\*Completions" "^\\*vc-diff" "^\\*Warnings\\*$" 'compilation-mode 'help-mode))

(defvar moyu/profiler-enabled nil)
#+end_src

* Start Up
** Configure
Add the `lisp` path to `load-path`, and generate cache directory and user config file if not exist. Use a separated `custom.el` to keep the `init.el` clean.
#+begin_src emacs-lisp :tangle yes
(add-to-list 'load-path
             (expand-file-name "lisp" user-emacs-directory))

(when-let (realhome
           (and *sys/win32*
                (getenv "USERPROFILE")))
  (setenv "HOME" realhome)
  (setq abbreviated-home-dir nil))

;; make cache directory
(unless (file-exists-p moyu/cache-directory)
  (make-directory moyu/cache-directory))
;; load user configs.
(unless (file-exists-p moyu/userconfig-file)
  (with-temp-file moyu/userconfig-file
    (setq-local coding-system-for-write 'utf-8)
    (goto-char (point-min))
    (insert
     ";; -*- mode: emacs-lisp -*-

(setq moyu/package-mirror default-package-mirror
      moyu/default-font (font-spec :family \"Consolas\"
                                     :size 14))")))
(load-file moyu/userconfig-file)

;; load `custom-file'
(setq custom-file moyu/custom-file)
(when (file-exists-p custom-file)
  (load custom-file))
#+end_src

Load the required packages for `init.el`.
#+begin_src emacs-lisp :tangle yes
(require 'core)
(require 'env-ext)
(require 'cl-lib)
(require 'package)
#+end_src

** GC
Add gc-action when state changed.
#+BEGIN_SRC emacs-lisp :tangle yes
(defvar better-gc-cons-threshold (* 16 1024 1024))

(if (boundp 'after-focus-change-function)
    (add-function :after after-focus-change-function
                  (lambda ()
                    (unless (frame-focus-state)
                      (garbage-collect)))))

(add-hook 'minibuffer-setup-hook
          (lambda ()
            (setq gc-cons-threshold (* better-gc-cons-threshold 2))))

(add-hook 'minibuffer-exit-hook
          (lambda ()
            (garbage-collect)
            (setq gc-cons-threshold better-gc-cons-threshold)))
#+END_SRC

** Packages
Initialize package manager. Elpa packages will be installed into named folders, packages will be reinstalled after Emacs is updated.
#+begin_src emacs-lisp :tangle yes
(setq package-enable-at-startup nil
      package-archives moyu/package-mirror
      package-user-dir (file-name-as-directory
                        (if (not moyu/elpa-subdirectory)
                            moyu/elpa-pack-dir
                          (let ((subdir (format "%d%s%d"
                                                emacs-major-version
                                                version-separator
                                                emacs-minor-version)))
                            (expand-file-name subdir moyu/elpa-pack-dir)))))

;; Load Emacs packages and initialize them.
(unless (bound-and-true-p package--initialized)
  (package-initialize))

;; Install use-package from melpa
(when (< emacs-major-version 29)
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package)))
#+end_src

** Enviroment
Generate enviroment file when not exists.
#+begin_src emacs-lisp :tangle yes
(unless (file-exists-p moyu/env-file)
  (generate-env-file moyu/env-file))

(defun moyu/generate-env-file (file)
  "Generate env FILE."
  (interactive)
  (generate-env-file moyu/env-file))
#+end_src

Load enviroment file.
#+begin_src emacs-lisp :tangle yes
(when (and (or initial-window-system
               (daemonp))
           moyu/env-file)
  (load-env-file moyu/env-file 'noerror))
#+end_src

* Editor
** Emacs
#+begin_src emacs-lisp :tangle yes
(use-package emacs
  :init
  ;; TAB cycle if there are only few candidates
  (setq completion-cycle-threshold 3)
  (define-advice completing-read-multiple (:filter-args (args))
    (cons (concat "[CRM]" (car args)) (cdr args)))
  ;; Do not allow the cursor in the minibuffer prompt
  (setq minibuffer-prompt-properties
        '(read-only t cursor-intangible t face minibuffer-prompt))
  (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

  ;; Enable indentation+completion using the TAB key.
  (setq tab-always-indent t)

  ;; Enable recursive minibuffers
  (setq enable-recursive-minibuffers t
        resize-mini-windows 'grow-only
        find-file-visit-truename t
        create-lockfiles nil
        make-backup-files nil
        ring-bell-function 'ignore
        version-control t
        backup-by-copying t
        delete-old-versions t
        kept-old-versions 5
        kept-new-versions 5
        backup-directory-alist moyu/backup-directory-alist
        auto-save-list-file-prefix moyu/auto-save-list-prefix)

  (setq-default auto-image-file-mode t
                initial-scratch-message "#+TITLE: SCRATCH\n#+AUTHOR: Liu\n\n"
                inhibit-splash-screen t
                initial-major-mode 'org-mode
                frame-title-format "ó°›“ Mo Yu :: %b"
                tab-width 4
	        indent-tabs-mode nil
                fill-column 80
                word-wrap t
                truncate-lines t)

  (when (boundp 'native-comp-eln-load-path)
    (add-to-list 'native-comp-eln-load-path moyu/profile-eln-caches-dir))

  (fset #'yes-or-no-p #'y-or-n-p))

;;;###autoload
(defun toggle-profiler ()
  "Toggle the Emacs profiler."
  (interactive)
  (if (not moyu/profiler-enabled)
      (profiler-start 'cpu+mem)
    (profiler-report)
    (profiler-stop))
  (setq moyu/profiler-enabled (not moyu/profiler-enabled)))
#+end_src

#+begin_src emacs-lisp :tangle yes
(when (>= emacs-major-version 28)
  (setq-default word-wrap-by-category t))

;; Default to soft line-wrapping in text modes.
(add-hook 'text-mode-hook #'visual-line-mode)

;; Create missing directory when we open a file that doesn't exist under
;; a directory tree tha may not exist.
(add-hook 'find-file-not-found-functions #'create-if-not-found)
#+end_src

** Tramp
#+begin_src emacs-lisp :tangle yes
(unless *sys/win32*
  (setq tramp-default-method "ssh"
        tramp-backup-directory-alist backup-directory-alist
        tramp-auto-save-directory (expand-file-name "tramp-autosave/" moyu/cache-directory)
        tramp-backup-directory-alist (expand-file-name "backup/" moyu/cache-directory)))

(with-eval-after-load 'tramp
  (setq remote-file-name-inihibit-cache 60
        tramp-completion-reread-directory-timeout 60
        tramp-verbose 1))
#+end_src

** Build-in Pacakges
*** paren
#+begin_src emacs-lisp :tangle yes
(use-package paren
  :hook (after-init . show-paren-mode)
  :config
  (setq show-paren-delay 0.1
        show-paren-highlight-openparen t
        show-paren-when-point-inside-paren t
        show-paren-when-point-in-periphery t))
#+end_src

*** recentf
#+begin_src emacs-lisp :tangle yes
(use-package recentf
  :commands (recentf-save-list)
  :init
  (add-hook 'find-file-hook (lambda ()
                              (unless recentf-mode
                                (recentf-mode)
                                (recentf-track-opened-file))))
  (setq recentf-save-file moyu/recentf-save-file
        recentf-max-saved-items 1000
        recentf-auto-cleanup 'never)

  (recentf-mode 1))
#+end_src

*** savehist
#+begin_src emacs-lisp :tangle yes
(use-package savehist
  :init
  ;; Minibuffer history
  (setq savehist-file (expand-file-name "savehist" moyu/cache-directory))
  (savehist-mode)
  :config
  (setq savehist-save-minibuffer-history t
        history-length 100
        savehist-autosave-interval 60
        savehist-additional-variables '(mark-ring
                                        global-mark-ring
                                        search-ring
                                        regexp-search-ring
                                        extended-command-history
                                        kill-ring)))
#+end_src

*** saveplace
#+begin_src emacs-lisp :tangle yes
(use-package saveplace
  :hook (after-init . save-place-mode)
  :init
  (setq save-place-file moyu/save-place-file))
#+end_src

*** subword
#+begin_src emacs-lisp :tangle yes
(use-package subword
  :hook (after-init . global-subword-mode))
#+end_src

*** autorevert
#+begin_src emacs-lisp :tangle yes
(use-package autorevert
  :ensure nil
  :hook (after-init . global-auto-revert-mode))
#+end_src

*** imenu
#+begin_src emacs-lisp :tangle yes
(use-package imenu)
#+end_src

*** display-fill-column-indicator
#+begin_src emacs-lisp :tangle yes
(when (>= emacs-major-version 27)
  (use-package display-fill-column-indicator))
#+end_src

*** compile
#+begin_src emacs-lisp :tangle yes
(use-package compile
  :config
  (setq compilation-always-kill t
        compilation-ask-about-save nil
        compilation-scroll-output 'first-error))
#+end_src

*** vc
#+begin_src emacs-lisp :tangle yes
(use-package vc
  :custom
  (vc-follow-link t))
#+end_src

*** treesit
#+begin_src emacs-lisp :tangle yes
(use-package treesit
  :when (and (fboundp 'treesit-available-p)
             (treesit-available-p))
  :custom
  (treesit-font-lock-level 4)
  :init
  (setq treesit-language-source-alist
        '((bash . ("https://github.com/tree-sitter/tree-sitter-bash"))
          (c . ("https://github.com/tree-sitter/tree-sitter-c"))
          (cpp . ("https://github.com/tree-sitter/tree-sitter-cpp"))
          (css . ("https://github.com/tree-sitter/tree-sitter-css"))
          (cmake . ("https://github.com/uyha/tree-sitter-cmake"))
          (csharp     . ("https://github.com/tree-sitter/tree-sitter-c-sharp.git"))
          (dockerfile . ("https://github.com/camdencheek/tree-sitter-dockerfile"))
          (elisp . ("https://github.com/Wilfred/tree-sitter-elisp"))
          (go . ("https://github.com/tree-sitter/tree-sitter-go"))
          (gomod      . ("https://github.com/camdencheek/tree-sitter-go-mod.git"))
          (html . ("https://github.com/tree-sitter/tree-sitter-html"))
          (java       . ("https://github.com/tree-sitter/tree-sitter-java.git"))
          (javascript . ("https://github.com/tree-sitter/tree-sitter-javascript"))
          (json . ("https://github.com/tree-sitter/tree-sitter-json"))
          (lua . ("https://github.com/Azganoth/tree-sitter-lua"))
          (make . ("https://github.com/alemuller/tree-sitter-make"))
          (markdown . ("https://github.com/MDeiml/tree-sitter-markdown" nil "tree-sitter-markdown/src"))
          (ocaml . ("https://github.com/tree-sitter/tree-sitter-ocaml" nil "ocaml/src"))
          (org . ("https://github.com/milisims/tree-sitter-org"))
          (python . ("https://github.com/tree-sitter/tree-sitter-python"))
          (php . ("https://github.com/tree-sitter/tree-sitter-php"))
          (typescript . ("https://github.com/tree-sitter/tree-sitter-typescript" nil "typescript/src"))
          (tsx . ("https://github.com/tree-sitter/tree-sitter-typescript" nil "tsx/src"))
          (ruby . ("https://github.com/tree-sitter/tree-sitter-ruby"))
          (rust . ("https://github.com/tree-sitter/tree-sitter-rust"))
          (sql . ("https://github.com/m-novikov/tree-sitter-sql"))
          (vue . ("https://github.com/merico-dev/tree-sitter-vue"))
          (yaml . ("https://github.com/ikatyang/tree-sitter-yaml"))
          (toml . ("https://github.com/tree-sitter/tree-sitter-toml"))
          (zig . ("https://github.com/GrayJack/tree-sitter-zig"))))
  )
#+end_src

** Smartparens
#+begin_src emacs-lisp :tangle yes
(use-package smartparens
  :ensure smartparens
  :commands (sp-pair sp-local-pair sp-with-modes sp-point-in-comment sp-point-in-string)
  :hook (after-init . smartparens-global-mode)
  :config
  (require 'smartparens-config)

  (with-eval-after-load 'evil
    (setq sp-show-pair-from-inside t))

  (let ((unless-list '(sp-point-before-word-p
                       sp-point-after-word-p
                       sp-point-before-same-p)))
    (sp-pair "'"  nil :unless unless-list)
    (sp-pair "\"" nil :unless unless-list))

  (sp-local-pair sp-lisp-modes "(" ")" :unless '(:rem sp-point-before-same-p))
  (sp-local-pair '(emacs-lisp-mode org-mode markdown-mode gfm-mode)
                 "[" nil :post-handlers '(:rem ("| " "SPC"))))
#+end_src

** Restart
#+begin_src emacs-lisp :tangle yes
(use-package restart-emacs
  :ensure t)
#+end_src

** Enviroment

** Ligature
#+begin_src emacs-lisp :tangle yes
(use-package ligature
  :ensure t)
#+end_src

** Emacs SQL
#+begin_src emacs-lisp :tangle yes
(use-package emacsql
  :ensure t)
#+end_src

* Completion
** Vertico based
*** orderless
#+begin_src emacs-lisp :tangle yes
(use-package orderless
  :ensure t
  :init
  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides '((file (styles partial-completion)))))
#+end_src

*** vertico
#+begin_src emacs-lisp :tangle yes
(use-package vertico
  :ensure t
  :bind (:map vertico-map
              ("DEL" . vertico-directory-delete-char))
  :init
  (vertico-mode)
  (setq vertico-resize nil
        vertico-cycle t)
  :config
  (add-hook 'rfn-eshadow-update-overlay-hook #'vertico-directory-tidy)
  (add-hook 'minibuffer-setup-hook #'vertico-repeat-save))
#+end_src

*** consult
#+begin_src emacs-lisp :tangle yes
(use-package consult
  :ensure t
  :after (vertico)
  :commands (consult-ripgrep consult-grep)
  :bind (([remap apropos]                       . consult-apropos)
         ([remap bookmark-jump]                 . consult-bookmark)
         ([remap evil-show-marks]               . consult-mark)
         ([remap evil-show-registers]           . consult-register)
         ([remap goto-line]                     . consult-goto-line)
         ([remap imenu]                         . consult-imenu)
         ([remap locate]                        . consult-locate)
         ([remap load-theme]                    . consult-theme)
         ([remap man]                           . consult-man)
         ([remap recentf-open-files]            . consult-recent-file)
         ([remap switch-to-buffer]              . consult-buffer)
         ([remap switch-to-buffer-other-window] . consult-buffer-other-window)
         ([remap switch-to-buffer-other-frame]  . consult-buffer-other-frame)
         ([remap yank-pop]                      . consult-yank-pop))
  :preface
  (advice-add #'multi-occur :override #'consult-multi-occur)
  :config
  (setq consult-line-numbers-widen t
        consult-async-min-input 2
        consult-async-refresh-delay 0.15
        consult-async-input-throttle 0.2
        consult-async-input-debounce 0.1)
  (consult-customize
   consult-ripgrep consult-git-grep consult-grep
   consult-bookmark consult-recent-file
   consult--source-recent-file consult--source-project-recent-file))

(use-package consult-xref
  :after xref
  :init
  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref))
#+end_src

*** corfu
#+begin_src emacs-lisp :tangle yes
(use-package corfu
  :ensure t
  ;; Optional customizations
  :custom
  (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
  (corfu-auto t)                 ;; Enable auto completion
  (corfu-separator ?\s)          ;; Orderless field separator
  ;; (corfu-quit-at-boundary nil)   ;; Never quit at completion boundary
  ;; (corfu-quit-no-match nil)      ;; Never quit, even if there is no match
  ;; (corfu-preview-current nil)    ;; Disable current candidate preview
  ;; (corfu-preselect-first nil)    ;; Disable candidate preselection
  ;; (corfu-on-exact-match nil)     ;; Configure handling of exact matches
  (corfu-echo-documentation nil) ;; Disable documentation in the echo area
  (corfu-scroll-margin 5)        ;; Use scroll margin

  ;; Enable Corfu only for certain modes.
  ;; :hook ((prog-mode . corfu-mode)
  ;;        (shell-mode . corfu-mode)
  ;;        (eshell-mode . corfu-mode))

  ;; Recommended: Enable Corfu globally.
  ;; This is recommended since Dabbrev can be used globally (M-/).
  ;; See also `corfu-excluded-modes'.
  :init
  (global-corfu-mode 1)
  (corfu-popupinfo-mode 1))
#+end_src

*** cape
#+begin_src emacs-lisp :tangle yes
(use-package cape
  :ensure t
  :init
  ;; Add to the global default value of `completion-at-point-functions' which is
  ;; used by `completion-at-point'.  The order of the functions matters, the
  ;; first function returning a result wins.  Note that the list of buffer-local
  ;; completion functions takes precedence over the global list.
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-elisp-block)
  (add-to-list 'completion-at-point-functions #'cape-history)
  (add-to-list 'completion-at-point-functions #'cape-keyword)
  (add-to-list 'completion-at-point-functions #'cape-tex)
  (add-to-list 'completion-at-point-functions #'cape-sgml)
  ;;(add-to-list 'completion-at-point-functions #'cape-rfc1345)
  (add-to-list 'completion-at-point-functions #'cape-abbrev)
  ;;(add-to-list 'completion-at-point-functions #'cape-dict)
  ;;(add-to-list 'completion-at-point-functions #'cape-elisp-symbol)
  ;;(add-to-list 'completion-at-point-functions #'cape-line)
  (advice-add #'eglot-completion-at-point :around #'cape-wrap-nonexclusive))
#+end_src

*** marginalia
#+begin_src emacs-lisp :tangle yes
(use-package marginalia
  :ensure t
  :hook (after-init . marginalia-mode)
  :init
  (marginalia-mode))
#+end_src

*** embark
#+begin_src emacs-lisp :tangle yes
(use-package embark
  :ensure t
  :init
  (setq prefix-help-command #'embark-prefix-help-command))

(use-package embark-consult
  :ensure t
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src
*** icons
#+begin_src emacs-lisp :tangle yes
(use-package nerd-icons-corfu
  :ensure t
  :init
  (with-eval-after-load 'corfu
    (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter)))
#+end_src

** Projects
*** project
#+begin_src emacs-lisp :tangle yes
(use-package project
  :bind (([remap project-shell] . project-eshell))
  :init
  (setq project-list-file moyu/project-list-file))
#+end_src

* Workspace
* Programming
** Configs
#+begin_src emacs-lisp :tangle yes

(defvar moyu/build-actions-map (make-sparse-keymap))

(defvar moyu/debug-actions-map (make-sparse-keymap))
#+end_src

** LSP
#+begin_src emacs-lisp :tangle yes
(use-package eglot
  :ensure t
  :hook (prog-mode . eglot-ensure)
  :init
  (define-advice eglot-ensure (:around (fn))
    (when (alist-get major-mode eglot-server-programs nil nil
                     (lambda (modes key)
                       (if (listp modes)
                           (member key modes)
                         (eq key modes))))
      (funcall fn)))
  (setq eglot-connect-timeout 10
        eglot-autoshutdown t
        eglot-send-changes-idle-time 0.5))

(use-package consult-eglot
  :ensure t
  :bind (([remap xref-find-apropos] . consult-eglot-symbols)))
#+end_src

** Debug

** Format
#+begin_src emacs-lisp :tangle yes
(use-package apheleia
  :ensure t
  :hook (after-init . apheleia-global-mode))
#+end_src

** Snippet
#+begin_src emacs-lisp :tangle yes
(use-package yasnippet
  :ensure t
  :commands (yas-minor-mode-on
             yas-expand
             yas-expand-snippet
             yas-lookup-snippet
             yas-insert-snippet
             yas-new-snippet
             yas-visit-extra-mode
             yas-active-extra-mode
             yas-deactive-extra-mode
             yas-maybe-expand-abbrev-key-filter)
  :init
  (setq yas-trigger-in-field t
        yas-wrap-around-region t
        yas-prompt-functions '(yas-completing-prompt))

  (add-hook 'prog-mode-hook #'yas-minor-mode)
  (add-hook 'org-mode-hook #'yas-minor-mode)
  :config
  (add-hook 'prog-mode-hook 'yas-reload-all))

(use-package yasnippet-snippets
  :ensure t
  :after yasnippet)

(use-package yasnippet-capf
  :ensure t
  :init
  (add-hook 'yas-minor-mode-hook
            (lambda () (add-hook 'completion-at-point-functions #'yasnippet-capf 30 t))))
#+end_src

** Lisp
*** elisp-mode
#+begin_src emacs-lisp :tangle yes
(defvar emacs-lisp-extend-imenu-list
  `(("Section" "^[ \t]*;;;*\\**[ \t]+\\([^\n]+\\)" 1)
    ("Unit tests" "^\\s-*(\\(?:ert-deftest\\|describe\\) +\"\\([^\")]+\\)\"" 1)
    ("Package" "^\\s-*\\(?:;;;###package\\|(\\(?:package!\\|use-package!?\\|after!\\)\\) +\\(\\_<[^ ()\n]+\\_>\\)" 1)
    ("Major modes" "^\\s-*(define-derived-mode +\\([^ ()\n]+\\)" 1)
    ("Minor modes" "^\\s-*(define-\\(?:global\\(?:ized\\)?-minor\\|generic\\|minor\\)-mode +\\([^ ()\n]+\\)" 1)
    ("Advice" "^\\s-*(\\(?:def\\(?:\\(?:ine-\\)?advice?\\)\\) +\\([^ )\n]+\\)" 1)
    ("Macros" "^\\s-*(\\(?:cl-\\)?def\\(?:ine-compile-macro\\|macro\\) +\\([^ )\n]+\\)" 1)
    ("Inline functions" "\\s-*(\\(?:cl-\\)?defsubst +\\([^ )\n]+\\)" 1)
    ("CLI Command" "^\\s-*(\\(def\\(?:cli\\|alias\\|obsolete\\|autoload\\)! +\\([^\n]+\\)\\)" 1)
    ("Functions" "^\\s-*(\\(?:cl-\\)?def\\(?:un\\|un\\*\\|method\\|generic\\) +\\([^ ,)\n]+\\)" 1)
    ("Variables" "^\\s-*(\\(def\\(?:c\\(?:onst\\(?:ant\\)?\\|ustom\\)\\|ine-symbol-macro\\|parameter\\|var\\(?:-local\\)?\\)\\)\\s-+\\(\\(?:\\sw\\|\\s_\\|\\\\.\\)+\\)" 2)
    ("Types" "^\\s-*(\\(cl-def\\(?:struct\\|type\\)\\|def\\(?:class\\|face\\|group\\|ine-\\(?:condition\\|error\\|widget\\)\\|package\\|struct\\|t\\(?:\\(?:hem\\|yp\\)e\\)\\)\\)\\s-+'?\\(\\(?:\\sw\\|\\s_\\|\\\\.\\)+\\)" 2)))

(use-package elisp-mode
  :mode ("\\.Cask\\'" . emacs-lisp-mode)
  :hook (emacs-lisp-mode . flymake-mode-on)
  :config
  (add-hook 'emacs-lisp-mode-hook #'outline-minor-mode)
  (add-hook 'emacs-lisp-mode-hook (lambda ()
                                    (setq imenu-generic-expression emacs-lisp-extend-imenu-list)))

  (define-advice elisp-get-var-docstring (:around (fn sym))
    (when-let (ret (funcall fn sym))
      (if (boundp sym)
          (concat ret " "
                  (let* ((truncated "[...]")
                         (print-escape-newlines t)
                         (str (prin1-to-string (symbol-value sym)))
                         (fn-str (prin1-to-string (symbol-function (quote fn))))
                         (limit (- (frame-width) (length fn-str) (length ret) (length truncated) 2)))
                    (format (format "%%0.%ds%%s" (max limit 0))
                            (propertize str 'face 'warning)
                            (if (< (length str) limit) "" truncated))))
        ret))))
#+end_src

*** buttercup
#+begin_src emacs-lisp :tangle yes
(use-package buttercup
  :ensure t
  :mode ("/test[/-].+\.el$" . buttercup-minor-mode)
  :init
  (add-to-list 'moyu/popper-buffers "^\\*Buttercup\\*$"))
#+end_src

*** geiser
#+begin_src emacs-lisp :tangle yes
(use-package geiser
  :ensure t
  :commands run-geiser
  :init
  (add-to-list 'moyu/popper-buffers "^\\*[gG]eiser \\(dbg\\|xref\\|messages\\|documentation\\|REPL\\)\\*$"))
#+end_src

*** lispy
#+begin_src emacs-lisp :tangle yes
(use-package lispy
  :ensure t
  :hook ((lisp-mode . lispy-mode)
         (emacs-lisp-mode . lispy-mode)
         (scheme-mode . lispy-mode)
         (ielm-mode . lispy-mode))
  :config
  (setq lispy-close-quotes-at-end-p t))
#+end_src

** Rust
*** rust-mode
#+begin_src emacs-lisp :tangle yes
(use-package rust-mode
  :ensure t
  :init
  (setq rust-mode-treesitter-derive t))
#+end_src

*** rustic
#+begin_src emacs-lisp :tangle yes
(use-package rustic
  :ensure t
  :after (rust-mode)
  :mode ("\\.rs$" . rustic-mode)
  :init
  (with-eval-after-load 'org-src
    (defalias 'org-babel-execute:rust #'org-babel-execute:rustic)
    (add-to-list 'org-src-lang-modes '("rust" . rustic)))
  (add-to-list 'moyu/popper-buffers "^\\*cargo-.*\\*$")
  (add-to-list 'moyu/popper-buffers "^\\*rustic-compilation")
  :config
  (setq rustic-indent-method-chain t
        rustic-babel-format-src-block nil)

  ;; HACK `rustic-lsp' sets up lsp-mode/eglot too early. We move it to
  ;;      `rustic-mode-local-vars-hook' so file/dir local variables can be used
  ;;      to reconfigure them.
  (setq rustic-lsp-client moyu/lsp-client))
#+end_src

** Python
#+begin_src emacs-lisp :tangle yes
(use-package python
  :mode ("\\.py\\'" . python-ts-mode)
  :mode ("[./]flake8\\'" . conf-mode)
  :custom
  (python-indent-offset 4)
  :init
  (setq python-enviroment-directory moyu/cache-directory
        python-indent-guess-indent-offset-verbose nil)
  (add-to-list 'moyu/popper-buffers "^\\*Python")
  :config
  (when (and (executable-find "python3")
             (string= python-shell-interpreter "python"))
    (setq python-shell-interpreter "python3")))

(use-package pyimport
  :ensure t)

(use-package poetry
  :ensure t
  :after python)
#+end_src

** C/C++
#+begin_src emacs-lisp :tangle yes
(use-package c-ts-mode
  :config)
#+end_src

#+begin_src emacs-lisp :tangle yes
(use-package cmake-ts-mode)
#+end_src

** Haskell

** Docker
*** dockerfile
#+begin_src emacs-lisp :tangle yes
(use-package dockerfile-ts-mode)
#+end_src

* Writting
** Configs
#+begin_src emacs-lisp :tangle yes
(use-package svg-tag-mode
  :ensure t)
#+end_src
** Org
*** variables
#+begin_src emacs-lisp :tangle yes
(defvar org/default-roam-capture
  '("d" "default" plain "%?"
    :if-new (file+head "${slug}.org"
                       "#+title: ${title}\n\n#+startup: indent\n")
    :unnarrowed t))

(defvar org/roam-templates nil)

(defvar org/roam-dailies-map (make-sparse-keymap))

(defvar org/todo-keywords
  '((sequence "TODO(t)" "LOOP(r)" "START(s)" "WAIT(w)" "HOLD(h)" "IDEA(i)" "|" "DONE(d)" "KILL(k)")))
#+end_src

*** org-mode
#+begin_src emacs-lisp :tangle yes
(use-package org
  :config
  ;; org files
  (setq-default org-directory moyu/notes-dir)
  (setq org-id-locations-file (expand-file-name ".orgids" org-directory)
        org-preview-latex-image-directory (concat moyu/cache-directory "org/latex/")
        org-list-allow-alphabetical t
        org-pretty-entities t)
  ;; org babels
  (setq org-src-preserve-indentation t
        org-src-tab-acts-natively t
        org-confirm-babel-evaluate nil
        org-link-elisp-confirm-function nil
        org-src-window-setup 'split-window-below)
  ;; org faces
  (setq org-indirect-buffer-display 'current-window
        org-enforce-todo-dependencies t
        org-fontify-done-headline t
        org-fontify-quote-and-verse-blocks t
        org-hide-leading-stars t
        org-image-actual-width nil
        org-startup-with-inline-images t
        org-imenu-depth 6
        org-startup-indented t
        org-tags-column 0
        org-startup-folded nil
        org-highlight-latex-and-related '(native script entities))
  (setq org-todo-keywords org/todo-keywords)
  ;; org agenda
  (setq-default org-agenda-files (list (concat "agendas/" moyu/notes-dir))
                org-agenda-skip-unavailable-files t
                org-agenda-span 20
                org-agenda-start-on-weekday nil
                org-agenda-start-day "-5d"
                org-agenda-inhibit-startup t)
  ;; attachements
  (setq org-attach-store-link-p t
        org-attach-use-inheritance t)
  ;; no space
  (require 'ox)
  (font-lock-add-keywords 'org-mode
                          '(("\\cc\\( \\)[/+*_=~][^a-zA-Z0-9]*?[/+*_=~]\\( \\)?\\cc?"
                             (1 (prog1 () (compose-region (match-beginning 1) (match-end 1) ""))))
                            ("\\cc?\\( \\)?[/+*_=~][^a-zA-Z0-9]*?[/+*_=~]\\( \\)\\cc"
                             (2 (prog1 () (compose-region (match-beginning 2) (match-end 2) "")))))
                          'append)
  (with-eval-after-load 'org
    (defun eli-strip-ws-maybe (text _backend _info)
      (let* ((text (replace-regexp-in-string
                    "\\(\\cc\\) *\n *\\(\\cc\\)"
                    "\\1\\2" text));; remove whitespace from line break
             ;; remove whitespace from `org-emphasis-alist'
             (text (replace-regexp-in-string "\\(\\cc\\) \\(.*?\\) \\(\\cc\\)"
                                             "\\1\\2\\3" text))
             ;; restore whitespace between English words and Chinese words
             (text (replace-regexp-in-string "\\(\\cc\\)\\(\\(?:<[^>]+>\\)?[a-z0-9A-Z-]+\\(?:<[^>]+>\\)?\\)\\(\\cc\\)"
                                             "\\1 \\2 \\3" text)))
        text)))
  (add-to-list 'org-export-filter-paragraph-functions #'eli-strip-ws-maybe)
  (plist-put org-format-latex-options :scale 1.5))
#+end_src

*** org-roam
#+begin_src emacs-lisp :tangle yes
(use-package org-roam
  :ensure org-roam
  :hook (after-init . org-roam-db-autosync-enable)
  :custom
  (org-roam-directory moyu/org-roam-dir)
  :commands (org-roam-buffer-toggle-display
             org-roam-tag-add
             org-roam-tag-delete)
  :init
  (require 'org-roam-dailies)
  (setq org-roam-db-location moyu/org-roam-db-location)
  :config
  (add-to-list 'org/roam-templates org/default-roam-capture)
  (setq org-roam-capture-templates org/roam-templates
        org-roam-node-display-template "${org-hierarchy}"))

(cl-defmethod org-roam-node-org-hierarchy ((node org-roam-node))
  "Return hierarchy for NODE, constructed of its file title, OLP and direct title.
If some elements are missing, the will be stripped out."
  (let* ((title (org-roam-node-title node))
         (olp (org-roam-node-olp node))
         (level (org-roam-node-level node))
         (filetitle (or (if (= level 0)
                            title
                          (org-roam-node-file-title node))))
         (separator (propertize ":" 'face 'shadow)))
    (cl-case level
      (0 filetitle)
      (1 (concat (propertize filetitle 'face '(shadow italic))
                 separator title))
      (t (concat (propertize filetitle 'face '(shadow italic))
                 separator (propertize (string-join olp separator) 'face '(shadow italic))
                 separator title)))))

;;;###autoload
(defun org/find-in-notes ()
  "Find file in notes directory."
  (interactive)
  (find--file-in-dir moyu/notes-dir))
#+end_src

*** valign
#+begin_src emacs-lisp :tangle yes
(use-package valign
  :ensure t
  :config
  (setq valign-fancy-bar t)
  (add-hook 'org-mode-hook #'valign-mode))
#+end_src

*** org-modern
#+begin_src emacs-lisp :tangle yes
(use-package org-modern
  :ensure t
  :hook (org-mode . org-modern-mode)
  :init
  (setq org-modern-table nil
        org-modern-keyword nil
        org-modern-block-name nil
        org-modern-block-fringe 0))
#+end_src

*** gnuplot
#+begin_src emacs-lisp :tangle yes
(use-package gnuplot
  :ensure gnuplot)
#+end_src

*** org-fragtog
#+begin_src emacs-lisp :tangle yes
(use-package org-fragtog
  :ensure t
  :hook (org-mode . org-fragtog-mode))
#+end_src

*** org-appear
#+begin_src emacs-lisp :tangle yes
(use-package org-appear
  :ensure t
  :hook (org-mode . org-appear-mode)
  :custom
  (org-appear-autoentities t)
  (org-appear-autoemphasis t)
  (org-appear-autosubmarkers t)
  (org-appear-autolinks t)
  (org-appear-inside-latex t))
#+end_src

** Markdown
#+begin_src emacs-lisp :tangle yes
(use-package markdown-mode
  :ensure t
  :mode ("/README\\(?:\\.md\\)?\\'" . gfm-mode)
  :init
  (setq markdown-enable-math t
        markdown-enable-wiki-links t
        markdown-italic-underscore t
        markdown-asymmetric-header t
        markdown-make-gfm-checkboxes-buttons t
        markdown-fontify-whole-heading-line t))
#+end_src

** TeX
#+begin_src emacs-lisp :tangle yes
(use-package auctex-latexmk
  :ensure t
  :after latex
  :init
  (setq auctex-latexmk-inherit-TeX-PDF-mode t)
  :config
  (auctex-latexmk-setup))

(use-package tex
  :ensure auctex
  :init
  (add-to-list 'moyu/popper-buffers " output\\*$")
  (add-to-list 'moyu/popper-buffers "^\\*TeX \\(?:Help\\|errors\\)")
  :config
  (setq TeX-parse-self t
      TeX-auto-save t
      TeX-auto-local ".auctex-auto"
      TeX-style-local ".auctex-style"
      TeX-source-correlate-mode t
      TeX-source-correlate-method 'synctex
      TeX-save-query nil))

(with-eval-after-load 'bibtex
  (setq bibtex-align-at-equal-sign t
        bibtex-text-indentation 20))

(use-package cdlatex
  :ensure t)
#+end_src

** Typst

** Edit convient
*** tempel
#+begin_src emacs-lisp :tanble yes
(use-package tempel
  :ensure t)
#+end_src

* Applications
** Version control
*** magit
#+begin_src emacs-lisp :tangle yes
(use-package magit
  :ensure t
  :init
  (setq transient-levels-file  (expand-file-name "transient/levels" moyu/cache-directory)
        transient-values-file  (expand-file-name "transient/values" moyu/cache-directory)
        transient-history-file (expand-file-name "transient/history" moyu/cache-directory))
  :config
  (setq transient-display-buffer-action '(display-buffer-below-selected)
        magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1
        magit-bury-buffer-function #'magit-mode-quit-window))

(use-package magit-gitflow
  :ensure t
  :hook (maigt-mode . turn-on-magit-gitflow))

(use-package magit-todos
  :ensure t)
#+end_src

*** git-gutter
#+begin_src emacs-lisp :tangle yes
(use-package git-gutter
  :ensure t
  :config
  (global-git-gutter-mode +1))
#+end_src

** Rime
#+begin_src emacs-lisp :tangle yes
(use-package rime
  :ensure t
  :if (not *sys/win32*)
  :custom
  (rime-show-candidate 'posframe)
  (default-input-method "rime")
  (rime-user-data-dir moyu/rime-data-dir)
  :init
  (add-hook 'after-init-hook
            (lambda ()
              (let ((rime-user-file (concat moyu/rime-data-dir "user.yaml")))
              (unless (file-exists-p moyu/rime-data-dir)
                (make-directory moyu/rime-data-dir)
                (with-temp-file rime-user-file
                  (setq-local coding-system-for-write 'utf-8)
                  (insert
                   "var:\n  previously_selected_schema: luna_pinyin_simp\n")))
              t))))
#+end_src

** Eshell
#+begin_src emacs-lisp :tangle yes
(defvar eshell-directory-name (expand-file-name "eshell" moyu/cache-directory))
(with-eval-after-load 'eshell
  (setq eshell-banner-message '(format "%s %s\n"
                                (propertize (format " %s " (string-trim (buffer-name)))
                                            'face 'mode-line-highlight)
                                (propertize (current-time-string)
                                            'face 'font-lock-keyword-face))
        eshell-scroll-to-bottom-on-input 'all
        eshell-scroll-to-bottom-on-output 'all
        eshell-kill-processes-on-exit t
        eshell-hist-ignoredups t
        eshell-glob-case-insensitive t
        eshell-error-if-no-glob t))

(add-to-list 'moyu/popper-buffers "\\.*eshell.*\\*$")
(add-to-list 'moyu/popper-buffers 'eshell-mode)
(add-to-list 'moyu/popper-buffers "\\.*-shell.*\\*$")
(add-to-list 'moyu/popper-buffers 'shell-mode)
#+end_src

* Keybindings
** Configs
#+begin_src emacs-lisp :tangle yes
(defvar moyu/leader-key "<SPC>"
  "The leader prefix key.")

(defvar moyu/localleader-key "M-m"
  "The localleader prefix key.")

(defun moyu/define-key (keymap &rest binds)
  "Define KEY-OPs at KEYMAP."
  (while (length> binds 1)
    (define-key keymap (kbd (pop binds)) (pop binds))))

(defmacro moyu/build-map-list (&rest binds)
  `(let ((map (make-sparse-keymap)))
     (moyu/define-key map ,@binds)
     map))

(defmacro moyu/create-keymap (name doc &rest binds)
  `(defvar ,name
     (moyu/build-map-list
      ,@(cl-loop for bind in binds
                 collect (if (listp bind)
                             (if (eq (car bind) 'function)
                                 `(function ,@(cdr bind))
                               (if (keymapp (cdr bind))
                                   (cons ,(car bind) (cdr bind))
                               `(cons ,(car bind) (moyu/build-map-list ,@(cdr bind)))))
                           bind)))
     ,doc))

(defmacro moyu/set-leader (states keymap &rest binds)
  `(evil-define-key ,states ,keymap
     ,@(let ((binds-list))
         (while (length> binds 1)
           (add-to-list 'binds-list `(kbd ,(concat "<leader>" (pop binds))) t)
           (add-to-list 'binds-list (pop binds) t))
         binds-list)))
#+end_src

** Which-key
#+begin_src emacs-lisp :tangle yes
(use-package which-key
  :ensure t
  :hook (after-init . which-key-mode)
  :init
  (setq which-key-sort-order #'which-key-key-order-alpha
        which-key-sort-uppercase-first nil
        which-key-add-column-padding 1
        which-key-max-display-columns nil
        which-key-min-display-lines 5)
  :config
  (which-key-setup-side-window-bottom)
  (setq which-key-show-early-on-C-h t
        which-key-max-description-length nil))
#+end_src

** Evil
#+begin_src emacs-lisp :tangle yes
(use-package undo-fu
  :ensure t)

;;; Keybinding
(use-package evil
  :ensure t
  :init
  (setq evil-want-keybinding nil
        evil-want-integration t)
  :config
  (evil-mode 1)
  (evil-set-undo-system 'undo-fu)
  (evil-set-leader '(normal motion visual) (kbd moyu/leader-key))
  (evil-set-leader '(insert replace emacs) (kbd moyu/localleader-key)))

(use-package evil-collection
  :after evil
  :ensure t
  :config
  (setq evil-collection-setup-minibuffer t)
  (evil-collection-init))
#+end_src

** Keymaps
#+begin_src emacs-lisp :tangle yes
(moyu/create-keymap moyu/file-manage-map
                    "Emacs file management commands."
                    "f" #'find-file
                    "s" #'save-buffer
                    "S" #'write-file
                    "r" #'recentf-open-files
                    "P" #'open-init-file)

(moyu/create-keymap moyu/buffer-manage-map
                    "Emacs buffer management commands."
                    "b" #'consult-buffer
                    "d" #'kill-current-buffer
                    "i" #'ibuffer
                    "k" #'kill-buffer-and-window
                    "r" #'revert-buffer
                    "R" #'rename-buffer
                    "]" #'next-buffer
                    "[" #'previous-buffer
                    "x" #'kill-buffer-and-window)

(moyu/create-keymap moyu/code-actions-map
                    "Code actions."
                    "a" #'eglot-code-actions
                    "b" ("build" moyu/build-actions-map)
                    "c" #'compile
                    "C" #'recompile
                    "f" #'apheleia-format-buffer
                    "j" #'eglot-find-declaration
                    "r" #'eglot-rename
                    "S" #'consult-eglot-symbols
                    "w" #'delete-trailing-whitespace
                    "x" #'consult-flymake)

(moyu/create-keymap moyu/search-map
                    "Searching in Emacs."
                    "i" #'imenu
                    "I" #'consult-imenu-multi
                    "s" #'consult-line
                    "S" #'consult-mark
                    "p" #'search-project
                    "d" #'search-current-work-dir
                    "M" #'consult-man)

(moyu/create-keymap moyu/git-actions-map
                    "Version control"
                    "/" #'magit-dispatch
                    "." #'magit-file-dispatch
                    "g" #'magit-status
                    "b" #'magit-branch-checkout
                    "B" #'magit-blame-addition
                    "C" #'magit-clone
                    "F" #'magit-fetch
                    "I" #'magit-init
                    "L" #'magit-log-buffer-file
                    "S" #'magit-stage-file
                    "t" #'git-timemachine-toggle
                    "U" #'magit-unstage-file
                    "R" #'vc-revert
                    "f" ("find"
                         "f" #'magit-find-file
                         "g" #'magit-find-git-config-file
                         "c" #'magit-show-commit)
                    )

(moyu/create-keymap moyu/goto-actions-map
                    ""
                    "l" #'goto-line)

(moyu/create-keymap moyu/notes-manage-map
                    "Notes Manager."
                    "c" #'org-capture
                    "I" #'org-id-get-create
                    "r" #'org-roam-node-find
                    "n" #'org-roam-capture
                    "v" #'org-search-view
                    "f" #'org/find-in-notes
                    "d" ("daily" org/roam-dailies-map))

(moyu/create-keymap moyu/open-map
                    "Open someting."
                    "a" ("Agenda" #'org-agenda)
                    "f" #'make-frame
                    "F" #'select-frame-by-name
                    "s" #'eshell
                    "t" #'org-todo-list
                    "T" #'toggle-profiler)

(moyu/create-keymap moyu/quit-map
                    "Quit Emacs."
                    "d" #'restart-server
                    "K" #'kill-emacs
                    "R" #'restart-emacs
                    "f" #'delete-frame)

(moyu/define-key help-map
                 "'" #'describe-char
                 "a" #'apropos
                 "A" #'apropos-documentation
                 "F" #'describe-face
                 "t" #'load-theme
                 "p" #'find-library
                 "C-l" #'describe-language-environment
                 "C-m" #'info-emacs-manual
                 "C-c" #'describe-coding-system)

(moyu/define-key evil-window-map
                 "m" #'delete-other-windows
                 "u" #'winner-undo
                 "d" #'evil-window-delete
                 "T" #'tear-off-window)
#+end_src

** Leader emacs
#+begin_src emacs-lisp :tangle yes
(moyu/set-leader nil 'global
                     "<SPC>" '("Exec" . execute-extended-command)
                     "." '("Find file" . find-file)
                     "'" '("Popper" . popper-toggle)
                     "a" '("Actions" . embark-act)
                     "b" (cons "buffer" moyu/buffer-manage-map)
                     "c" (cons "code" moyu/code-actions-map)
                     "f" (cons "file" moyu/file-manage-map)
                     "g" (cons "git" moyu/git-actions-map)
                     "G" (cons "goto" moyu/goto-actions-map)
                     "h" (cons "help" help-map)
                     "n" (cons "notes" moyu/notes-manage-map)
                     "p" (cons "projects" project-prefix-map)
                     "q" (cons "quit/restart" moyu/quit-map)
                     "o" (cons "open" moyu/open-map)
                     "s" (cons "searching" moyu/search-map)
                     "w" (cons "window" evil-window-map))
#+end_src

* UI
** Font
#+begin_src emacs-lisp :tangle yes
(let ((hook (if (daemonp)
                'server-after-make-frame-hook
              'after-init-hook)))
  (add-hook hook (lambda () (init-fonts-in-emacs moyu/default-font moyu/serif-font)) -100))
#+end_src

** Theme
#+begin_src emacs-lisp :tangle yes
(use-package doom-themes
  :ensure t)

(defun editor/init-theme ()
  "Initialize Emacs theme."
  (when (and moyu/theme (not (custom-theme-enabled-p moyu/theme)))
    (disable-theme custom-enabled-themes)
    (load-theme moyu/theme t)))

(let ((hook (if (daemonp)
                'server-after-make-frame-hook
              'after-init-hook)))
  (add-hook hook #'editor/init-theme -99))
#+end_src

#+begin_src emacs-lisp :tangle yes
(use-package all-the-icons
  :ensure t
  :if (display-graphic-p)
  :preface
  (add-hook 'after-setting-font-hook
            (lambda ()
              (when (fboundp 'set-fontset-font)
                (dolist (font (list "Weather Icons"
                                    "github-octicons"
                                    "FontAwesome"
                                    "all-the-icons"
                                    "file-icons"
                                    "Material Icons"))
                  (set-fontset-font t 'unicode (font-spec :family font) nil 'append))))))
#+end_src

** Modeline
#+begin_src emacs-lisp :tangle yes
(use-package doom-modeline
  :ensure t
  :hook (after-init . doom-modeline-mode)
  :hook (doom-modeline . size-indication-mode)
  :hook (doom-modeline . column-number-mode)
  :init
  (setq doom-modeline-bar-width 3
        doom-modeline-github nil
        doom-modeline-mu4e nil
        doom-modeline-persp-name nil
        doom-modeline-minor-modes nil
        doom-modeline-major-mode-icon nil
        doom-modeline-buffer-file-name-style 'relative-from-project
        doom-modeline-buffer-encoding t)

  (when (daemonp)
    (setq doom-modeline-icon t))

  :config
  (setq doom-modeline-project-detection 'project)

  (use-package anzu
    :ensure t)
  (use-package evil-anzu
    :ensure t
    :config (global-anzu-mode +1)))
#+end_src

** Scrolling
#+begin_src emacs-lisp :tangle yes
(setq hscroll-margin 2
      hscroll-step 1
      ;; Emacs spends too much effort recentering the screen if you scroll the
      ;; cursor more than N lines past window edges (where N is the settings of
      ;; `scroll-conservatively'). This is especially slow in larger files
      ;; during large-scale scrolling commands. If kept over 100, the window is
      ;; never automatically recentered. The default (0) triggers this too
      ;; aggressively, so I've set it to 10 to recenter if scrolling too far
      ;; off-screen.
      scroll-conservatively 10
      scroll-margin 0
      scroll-preserve-screen-position t
      ;; Reduce cursor lag by a tiny bit by not auto-adjusting `window-vscroll'
      ;; for tall lines.
      auto-window-vscroll nil
      ;; mouse
      mouse-wheel-scroll-amount '(2 ((shift) . hscroll))
      mouse-wheel-scroll-amount-horizontal 2)
#+end_src

** Window
*** Display
#+begin_src emacs-lisp :tangle yes
(use-package display-line-numbers
  :hook
  (prog-mode . display-line-numbers-mode))

;; Don't display floating tooltips;
(when (bound-and-true-p tooltip-mode)
  (tooltip-mode -1))

(add-hook 'emacs-startup-hook #'window-divider-mode)
#+end_src

*** writeroom-mode
#+begin_src emacs-lisp :tangle yes
(use-package writeroom-mode
  :ensure t
  :config
  (setq writeroom-width 100)
  (setq writeroom-global-effects
        '(writeroom-set-alpha
          writeroom-set-menu-bar-lines
          writeroom-set-tool-bar-lines
          writeroom-set-vertical-scroll-bars
          writeroom-set-bottom-divider-width)))
#+end_src

*** popper
#+begin_src emacs-lisp :tangle yes
(use-package popper
  :ensure t
  :bind (("C-`"    . popper-toggle)
         ("M-'"    . popper-cycle))
  :init
  (setq popper-reference-buffers moyu/popper-buffers)
  (popper-mode +1)
  (popper-echo-mode +1)
  :config
  (setq popper-group-function #'popper-group-by-project
        popper-mode-line-position 2))
#+end_src
